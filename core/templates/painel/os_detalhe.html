{% extends "painel/base.html" %}
{% load static %}

{% block title %}CheckAuto - Detalhes da OS{% endblock %}

{% block page_title %}
Detalhes da OS
{% endblock %}

{% block page_subtitle %}
Timeline do veículo e fotos por etapa.
{% endblock %}

{% block content %}

<div id="os-erro" class="hidden mb-4 bg-rose-900/40 border border-rose-700/70 text-rose-100 text-xs rounded-xl px-3 py-2">
    Ocorreu um erro ao carregar os dados desta OS. Verifique o console ou tente novamente.
</div>

<!-- Cabeçalho da OS -->
<div id="os-header" class="mb-4 bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col gap-3">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <p id="os-codigo" class="text-xs text-slate-400 uppercase tracking-wide mb-1">
                OS —
            </p>
            <h2 id="os-placa-modelo" class="text-sm md:text-base font-semibold text-slate-50">
                <!-- preenchido via JS -->
            </h2>
            <p id="os-cliente" class="text-xs text-slate-400">
                <!-- preenchido via JS -->
            </p>
        </div>

        <div class="flex flex-wrap gap-2 text-[11px]">
            <div class="px-3 py-1 rounded-full border border-slate-700/70 bg-slate-900/70 flex items-center gap-2">
                <span class="text-slate-400">Etapa atual:</span>
                <span id="os-etapa" class="font-medium text-slate-100">—</span>
            </div>
            <div class="px-3 py-1 rounded-full border border-slate-700/70 bg-slate-900/70 flex items-center gap-2">
                <span class="text-slate-400">Status:</span>
                <span id="os-status" class="font-medium">—</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-[11px] text-slate-300 mt-2">
        <div>
            <p class="text-slate-500 mb-1 uppercase tracking-wide text-[10px]">Entrada</p>
            <p id="os-data-entrada">—</p>
        </div>
        <div>
            <p class="text-slate-500 mb-1 uppercase tracking-wide text-[10px]">Prevista entrega</p>
            <p id="os-data-prevista">—</p>
        </div>
        <div>
            <p class="text-slate-500 mb-1 uppercase tracking-wide text-[10px]">Saída</p>
            <p id="os-data-saida">—</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Etapa atual da OS -->
    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 lg:col-span-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
            <div>
                <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">Etapa atual</h3>
                <p class="text-[11px] text-slate-400">Selecione manualmente a etapa desta OS.</p>
            </div>
            <div id="etapa-feedback" class="text-[11px] text-emerald-300 hidden"></div>
        </div>

        <div class="flex flex-col md:flex-row md:items-end gap-3 text-[11px] text-slate-200">
            <label class="flex-1 flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Etapa</span>
                <select id="selectEtapaAtual" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <option value="">Carregando etapas...</option>
                </select>
            </label>
            <div class="flex flex-wrap gap-2">
                <button id="btnVoltarEtapa" type="button" class="px-3 py-1.5 text-[11px] font-semibold rounded-full bg-slate-800 hover:bg-slate-700 text-white transition">
                    Voltar etapa
                </button>
                <button id="btnAvancarEtapa" type="button" class="px-3 py-1.5 text-[11px] font-semibold rounded-full bg-slate-800 hover:bg-slate-700 text-white transition">
                    Avançar etapa
                </button>
                <button id="btnSalvarEtapa" type="button" class="px-3 py-1.5 text-[11px] font-semibold rounded-full bg-emerald-600 hover:bg-emerald-500 text-white transition">
                    Salvar etapa
                </button>
            </div>
        </div>
    </section>

    <!-- Edição básica da OS -->
    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 lg:col-span-3">
        <div class="flex items-center justify-between mb-3">
            <div>
                <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">Editar OS</h3>
                <p class="text-[11px] text-slate-400">Atualize datas e status desta ordem de serviço.</p>
            </div>
            <button id="os-edit-salvar" type="button" class="px-3 py-1.5 text-[11px] font-semibold rounded-full bg-indigo-600 hover:bg-indigo-500 text-white transition disabled:opacity-60 disabled:cursor-not-allowed">
                Salvar alterações
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-[11px] text-slate-200">
            <label class="flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Data de entrega</span>
                <input id="os-edit-data-entrega" type="date" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </label>
            <label class="flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Data de saída</span>
                <input id="os-edit-data-saida" type="date" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </label>
            <label class="flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Status</span>
                <select id="os-edit-status" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <option value="aberta">Aberta</option>
                    <option value="fechada">Fechada</option>
                </select>
            </label>
        </div>
    </section>

    <!-- Observações por etapa -->
    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 lg:col-span-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
            <div>
                <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">Observações por etapa</h3>
                <p class="text-[11px] text-slate-400">Selecione uma etapa para visualizar ou salvar observações específicas.</p>
            </div>
            <div id="observacao-feedback" class="text-[11px] hidden"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-[11px] text-slate-200">
            <label class="flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Etapa</span>
                <select id="selectObservacaoEtapa" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <option value="">Carregando etapas...</option>
                </select>
            </label>
            <div class="md:col-span-2 flex flex-col gap-1">
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">Observação</span>
                <textarea id="textareaObservacaoEtapa" rows="3" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Digite a observação da etapa"></textarea>
            </div>
        </div>

        <div class="flex justify-end mt-3">
            <button id="btnSalvarObservacao" type="button" class="px-3 py-1.5 text-[11px] font-semibold rounded-full bg-indigo-600 hover:bg-indigo-500 text-white transition">
                Salvar observação
            </button>
        </div>
    </section>

    <!-- Timeline -->
    <section class="lg:col-span-1 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
        <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide mb-2">
            Timeline
        </h3>
        <p class="text-[11px] text-slate-400 mb-3">
            Evolução da OS com base nas datas de entrada, saída e fotos registradas.
        </p>
        <ol id="os-timeline" class="relative border-l border-slate-700/60 pl-4 text-[11px] text-slate-200">
            <!-- itens preenchidos via JS -->
        </ol>
        <p id="os-timeline-vazio" class="hidden text-[11px] text-slate-500">
            Nenhum evento registrado nesta OS.
        </p>
    </section>

    <!-- Galeria de fotos -->
    <section class="lg:col-span-2 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">
                Fotos por etapa
            </h3>
            <p id="os-fotos-count" class="text-[11px] text-slate-500">
                —
            </p>
        </div>

        <div class="mb-3 border border-slate-800 rounded-2xl p-3 bg-slate-950/40">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
                <div>
                    <h4 class="text-[11px] font-semibold text-slate-200 uppercase tracking-wide">Adicionar foto (livre)</h4>
                    <p class="text-[10px] text-slate-400">Envie uma nova foto para esta OS.</p>
                </div>
                <span id="foto-upload-feedback" class="hidden text-[11px]"></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-[11px] text-slate-200">
                <label class="flex flex-col gap-1">
                    <span class="text-slate-400 text-[10px] uppercase tracking-wide">Arquivo</span>
                    <input id="fotoLivreInput" type="file" accept="image/*" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500" />
                </label>

                <label class="flex flex-col gap-1">
                    <span class="text-slate-400 text-[10px] uppercase tracking-wide">Etapa (opcional)</span>
                    <select id="fotoLivreEtapaSelect" class="bg-slate-950/70 border border-slate-800 rounded-lg px-2 py-2 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        <option value="">Sem etapa</option>
                    </select>
                </label>

                <div class="flex items-end">
                    <button id="btnEnviarFotoLivre" type="button" class="w-full px-3 py-2 text-[11px] font-semibold rounded-full bg-indigo-600 hover:bg-indigo-500 text-white transition">
                        Enviar foto
                    </button>
                </div>
            </div>
        </div>

        <div id="os-fotos-vazio" class="hidden text-[11px] text-slate-500 mb-2">
            Nenhuma foto registrada para esta OS até o momento.
        </div>

        <div id="os-fotos-container" class="space-y-4">
            <!-- grupos de fotos por etapa preenchidos via JS -->
        </div>
    </section>
</div>

<div id="foto-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div id="foto-modal-backdrop" class="absolute inset-0 bg-slate-900/80"></div>
    <div class="relative bg-slate-950 border border-slate-800 rounded-2xl max-w-4xl w-[90%] max-h-[90vh] p-3 flex flex-col shadow-xl shadow-black/40">
        <button id="foto-modal-close" type="button" class="absolute top-2 right-2 text-slate-200 hover:text-white bg-slate-800/80 hover:bg-slate-700/80 border border-slate-700/70 rounded-full w-8 h-8 flex items-center justify-center text-sm">
            ✕
        </button>
        <div class="flex-1 overflow-auto flex items-center justify-center mt-4">
            <img id="foto-modal-img" src="" alt="" class="max-h-[80vh] max-w-full object-contain" />
        </div>
    </div>
</div>

<script src="{% static 'painel/js/auth.js' %}"></script>
<script src="{% static 'painel/js/api.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    (async () => {
        const autenticado = await verificarAutenticacao();
        if (!autenticado) return;

        const erroBox = document.getElementById("os-erro");

        // Extrai o ID da OS a partir da URL: /painel/os/<id>/
        const parts = window.location.pathname.split("/").filter(Boolean);
        const osId = parts[parts.length - 1];

        // Elementos de cabeçalho
        const elCodigo = document.getElementById("os-codigo");
        const elPlacaModelo = document.getElementById("os-placa-modelo");
        const elCliente = document.getElementById("os-cliente");
        const elEtapa = document.getElementById("os-etapa");
        const elStatus = document.getElementById("os-status");
        const elDataEntrada = document.getElementById("os-data-entrada");
        const elDataPrevista = document.getElementById("os-data-prevista");
        const elDataSaida = document.getElementById("os-data-saida");

        // Timeline
        const elTimeline = document.getElementById("os-timeline");
        const elTimelineVazio = document.getElementById("os-timeline-vazio");

        // Fotos
        const elFotosCount = document.getElementById("os-fotos-count");
        const elFotosVazio = document.getElementById("os-fotos-vazio");
        const elFotosContainer = document.getElementById("os-fotos-container");
        const mensagemFotosPadrao = elFotosVazio.textContent;

        // Upload de foto livre
        const elFotoLivreInput = document.getElementById("fotoLivreInput");
        const elFotoLivreEtapaSelect = document.getElementById("fotoLivreEtapaSelect");
        const elBtnEnviarFotoLivre = document.getElementById("btnEnviarFotoLivre");
        const elFotoUploadFeedback = document.getElementById("foto-upload-feedback");

        // Modal de visualização de foto
        const elFotoModal = document.getElementById("foto-modal");
        const elFotoModalBackdrop = document.getElementById("foto-modal-backdrop");
        const elFotoModalClose = document.getElementById("foto-modal-close");
        const elFotoModalImg = document.getElementById("foto-modal-img");

        // Formulário de edição
        const elEditDataEntrega = document.getElementById("os-edit-data-entrega");
        const elEditDataSaida = document.getElementById("os-edit-data-saida");
        const elEditStatus = document.getElementById("os-edit-status");
        const elEditSalvar = document.getElementById("os-edit-salvar");

        // Controles de etapa
        const elSelectEtapaAtual = document.getElementById("selectEtapaAtual");
        const elBtnVoltarEtapa = document.getElementById("btnVoltarEtapa");
        const elBtnAvancarEtapa = document.getElementById("btnAvancarEtapa");
        const elBtnSalvarEtapa = document.getElementById("btnSalvarEtapa");
        const elEtapaFeedback = document.getElementById("etapa-feedback");
        const elSelectObservacaoEtapa = document.getElementById("selectObservacaoEtapa");
        const elTextareaObservacaoEtapa = document.getElementById("textareaObservacaoEtapa");
        const elBtnSalvarObservacao = document.getElementById("btnSalvarObservacao");
        const elObservacaoFeedback = document.getElementById("observacao-feedback");

        let osDadosAtuais = null;
        let fotosCache = [];
        let etapasCache = [];
        let observacoesCache = [];
        let timelineCache = [];

        function abrirModalImagem(url, altTexto) {
            if (!url) return;
            elFotoModalImg.src = url;
            elFotoModalImg.alt = altTexto || "";
            elFotoModal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
        }

        function fecharModalImagem() {
            elFotoModal.classList.add("hidden");
            elFotoModalImg.src = "";
            elFotoModalImg.alt = "";
            document.body.classList.remove("overflow-hidden");
        }

        elFotoModalBackdrop.addEventListener("click", fecharModalImagem);
        elFotoModalClose.addEventListener("click", fecharModalImagem);

        function formatarData(dataStr) {
            if (!dataStr) return "-";
            const apenasData = dataStr.split("T")[0];
            const partes = apenasData.split("-");
            if (partes.length === 3) {
                return partes[2] + "/" + partes[1] + "/" + partes[0];
            }
            return apenasData;
        }

        function formatarDataHora(dataStr) {
            if (!dataStr) return "-";
            try {
                const d = new Date(dataStr);
                const dia = String(d.getDate()).padStart(2, "0");
                const mes = String(d.getMonth() + 1).padStart(2, "0");
                const ano = d.getFullYear();
                const hora = String(d.getHours()).padStart(2, "0");
                const min = String(d.getMinutes()).padStart(2, "0");
                return `${dia}/${mes}/${ano} ${hora}:${min}`;
            } catch (e) {
                return dataStr;
            }
        }

        function dataParaInput(dateStr) {
            if (!dateStr) return "";
            return dateStr.split("T")[0] || "";
        }

        function toggleSalvando(ativo) {
            if (!elEditSalvar) return;
            elEditSalvar.disabled = ativo;
            elEditSalvar.textContent = ativo ? "Salvando..." : "Salvar alterações";
        }

        function mostrarEtapaFeedback(texto, sucesso = true) {
            if (!elEtapaFeedback) return;

            elEtapaFeedback.textContent = texto;
            elEtapaFeedback.classList.remove("hidden");
            elEtapaFeedback.classList.toggle("text-emerald-300", sucesso);
            elEtapaFeedback.classList.toggle("text-rose-300", !sucesso);
        }

        function limparEtapaFeedback() {
            if (!elEtapaFeedback) return;
            elEtapaFeedback.classList.add("hidden");
            elEtapaFeedback.textContent = "";
        }

        function mostrarObservacaoFeedback(texto, sucesso = true) {
            if (!elObservacaoFeedback) return;

            elObservacaoFeedback.textContent = texto;
            elObservacaoFeedback.classList.remove("hidden");
            elObservacaoFeedback.classList.toggle("text-emerald-300", sucesso);
            elObservacaoFeedback.classList.toggle("text-rose-300", !sucesso);
        }

        function limparObservacaoFeedback() {
            if (!elObservacaoFeedback) return;
            elObservacaoFeedback.classList.add("hidden");
            elObservacaoFeedback.textContent = "";
        }

        function mostrarUploadFeedback(texto, sucesso = true) {
            if (!elFotoUploadFeedback) return;

            elFotoUploadFeedback.textContent = texto;
            elFotoUploadFeedback.classList.remove("hidden");
            elFotoUploadFeedback.classList.toggle("text-emerald-300", sucesso);
            elFotoUploadFeedback.classList.toggle("text-rose-300", !sucesso);
        }

        function limparUploadFeedback() {
            if (!elFotoUploadFeedback) return;
            elFotoUploadFeedback.classList.add("hidden");
            elFotoUploadFeedback.textContent = "";
        }

        function marcarBotaoCarregando(btn, ativo, textoCarregando = "Processando...") {
            if (!btn) return () => {};

            const original = btn.textContent;
            btn.disabled = !!ativo;
            btn.textContent = ativo ? textoCarregando : original;

            return () => {
                btn.disabled = false;
                btn.textContent = original;
            };
        }

        function obterIdEtapa(obs) {
            if (!obs) return null;

            if (typeof obs.etapa === "object" && obs.etapa !== null) {
                return obs.etapa.id ?? null;
            }

            return obs.etapa ?? null;
        }

        function getEtapaAtualId(os) {
            if (!os) return null;
            const etapaAtual = os.etapa_atual;
            if (etapaAtual && typeof etapaAtual === "object") {
                return etapaAtual.id ?? null;
            }
            return etapaAtual ?? null;
        }

        function preencherSelectEtapas(etapas) {
            if (elSelectEtapaAtual) {
                elSelectEtapaAtual.innerHTML = "";

                if (!etapas || !etapas.length) {
                    const opt = document.createElement("option");
                    opt.value = "";
                    opt.textContent = "Nenhuma etapa disponível";
                    elSelectEtapaAtual.appendChild(opt);
                } else {
                    etapas.forEach((etapa) => {
                        const opt = document.createElement("option");
                        opt.value = etapa.id;
                        opt.textContent = etapa.nome || `Etapa ${etapa.id}`;
                        elSelectEtapaAtual.appendChild(opt);
                    });
                }
            }

            if (elFotoLivreEtapaSelect) {
                const manterSelecao = elFotoLivreEtapaSelect.value;
                elFotoLivreEtapaSelect.innerHTML = "";

                const optDefault = document.createElement("option");
                optDefault.value = "";
                optDefault.textContent = "Sem etapa";
                elFotoLivreEtapaSelect.appendChild(optDefault);

                (etapas || []).forEach((etapa) => {
                    const opt = document.createElement("option");
                    opt.value = etapa.id;
                    opt.textContent = etapa.nome || `Etapa ${etapa.id}`;
                    elFotoLivreEtapaSelect.appendChild(opt);
                });

                elFotoLivreEtapaSelect.value = manterSelecao ?? "";
            }
        }

        function preencherSelectObservacaoEtapa(etapas) {
            if (!elSelectObservacaoEtapa) return;

            elSelectObservacaoEtapa.innerHTML = "";

            if (!etapas || !etapas.length) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Nenhuma etapa disponível";
                elSelectObservacaoEtapa.appendChild(opt);
                return;
            }

            etapas.forEach((etapa) => {
                const opt = document.createElement("option");
                opt.value = etapa.id;
                opt.textContent = etapa.nome || `Etapa ${etapa.id}`;
                elSelectObservacaoEtapa.appendChild(opt);
            });
        }

        function selecionarEtapaAtual(os) {
            if (!elSelectEtapaAtual) return;
            const etapaId = getEtapaAtualId(os);
            elSelectEtapaAtual.value = etapaId !== null && etapaId !== undefined ? String(etapaId) : "";
        }

        function moverEtapaAtual(offset) {
            if (!elSelectEtapaAtual || !elSelectEtapaAtual.options.length) return;
            const novoIndex = Math.min(
                Math.max(elSelectEtapaAtual.selectedIndex + offset, 0),
                elSelectEtapaAtual.options.length - 1,
            );
            elSelectEtapaAtual.selectedIndex = novoIndex;
        }

        async function carregarEtapas() {
            try {
                const resp = await apiFetch("/api/etapas/");
                if (!resp.ok) {
                    const texto = await resp.text();
                    console.error("Erro ao carregar etapas:", resp.status, texto);
                    preencherSelectEtapas([]);
                    return [];
                }

                const data = await resp.json();
                const lista = data && Array.isArray(data.results)
                    ? data.results
                    : Array.isArray(data)
                        ? data
                        : [];

                lista.sort((a, b) => {
                    const ordemA = a.ordem ?? a.id ?? 0;
                    const ordemB = b.ordem ?? b.id ?? 0;
                    if (ordemA !== ordemB) return ordemA - ordemB;
                    return (a.id ?? 0) - (b.id ?? 0);
                });

                etapasCache = lista;
                preencherSelectEtapas(lista);
                preencherSelectObservacaoEtapa(lista);
                return lista;
            } catch (err) {
                console.error("Erro inesperado ao carregar etapas:", err);
                preencherSelectEtapas([]);
                preencherSelectObservacaoEtapa([]);
                return [];
            }
        }

        async function recarregarOsBasico() {
            try {
                const resp = await apiFetch(`/api/os/${osId}/`);
                if (!resp.ok) return;

                const osData = await resp.json();
                osDadosAtuais = osData;
                preencherCabecalho(osData);
                preencherFormulario(osData);
                selecionarEtapaAtual(osData);
                selecionarEtapaObservacao(osData);
            } catch (err) {
                console.error("Erro ao recarregar OS", err);
            }
        }

        async function carregarTimeline() {
            try {
                const resp = await apiFetch(`/api/os/${osId}/timeline/`);
                if (!resp.ok) {
                    const texto = await resp.text();
                    console.error("Erro ao carregar timeline:", resp.status, texto);
                    timelineCache = [];
                    preencherTimeline();
                    return [];
                }

                const data = await resp.json();
                const lista = Array.isArray(data.results)
                    ? data.results
                    : Array.isArray(data)
                        ? data
                        : data.timeline || [];

                timelineCache = lista;
                preencherTimeline();
                return lista;
            } catch (err) {
                console.error("Erro inesperado ao carregar timeline:", err);
                timelineCache = [];
                preencherTimeline();
                return [];
            }
        }

        async function marcarEtapa(etapaId, botao) {
            const restaurar = marcarBotaoCarregando(botao, true, "Salvando...");

            try {
                const resp = await apiFetch(`/api/os/${osId}/timeline/marcar-concluida/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ etapa: etapaId }),
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    alert(`Erro ${resp.status}: ${texto}`);
                    return;
                }

                const data = await resp.json();
                timelineCache = data.timeline || [];
                preencherTimeline();
                await recarregarOsBasico();
                alert("Etapa marcada como concluída.");
            } catch (err) {
                console.error("Erro ao marcar etapa concluída:", err);
                alert("Erro ao marcar etapa. Tente novamente.");
            } finally {
                restaurar();
            }
        }

        async function reabrirEtapa(etapaId, botao) {
            const restaurar = marcarBotaoCarregando(botao, true, "Reabrindo...");

            try {
                const resp = await apiFetch(`/api/os/${osId}/timeline/reabrir/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ etapa: etapaId }),
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    alert(`Erro ${resp.status}: ${texto}`);
                    return;
                }

                const data = await resp.json();
                timelineCache = data.timeline || [];
                preencherTimeline();
                await recarregarOsBasico();
                alert("Etapa reaberta.");
            } catch (err) {
                console.error("Erro ao reabrir etapa:", err);
                alert("Erro ao reabrir etapa. Tente novamente.");
            } finally {
                restaurar();
            }
        }

        async function carregarDados() {
            const osUrl = `/api/os/${osId}/`;
            const fotosUrl = `/api/fotos-os/?os=${osId}`;
            const etapasPromise = carregarEtapas();
            const observacoesUrl = `/api/os/${osId}/observacoes/`;

            try {
                const [osResp, fotosResp, observacoesResp] = await Promise.all([
                    apiFetch(osUrl),
                    apiFetch(fotosUrl),
                    apiFetch(observacoesUrl),
                ]);

                if (osResp.status === 404) {
                    alert("OS não encontrada");
                    return;
                }
                if (!osResp.ok) {
                    const t = await osResp.text();
                    console.error("Erro ao buscar detalhes da OS:", osResp.status, t);
                    throw new Error("Erro ao buscar OS");
                }

                const osData = await osResp.json();
                osDadosAtuais = osData;

                await etapasPromise;

                let fotosData = [];
                let erroFotos = false;
                let observacoesData = [];

                if (fotosResp.ok) {
                    try {
                        const raw = await fotosResp.json();
                        if (Array.isArray(raw.results)) {
                            fotosData = raw.results;
                        } else if (Array.isArray(raw)) {
                            fotosData = raw;
                        }
                    } catch (e) {
                        fotosData = [];
                    }
                } else {
                    erroFotos = true;
                    const t = await fotosResp.text();
                    console.error("Erro ao buscar fotos da OS:", fotosResp.status, t);
                }

                if (observacoesResp.ok) {
                    try {
                        const raw = await observacoesResp.json();
                        if (Array.isArray(raw.results)) {
                            observacoesData = raw.results;
                        } else if (Array.isArray(raw)) {
                            observacoesData = raw;
                        }
                    } catch (e) {
                        observacoesData = [];
                    }
                } else {
                    const t = await observacoesResp.text();
                    console.error(
                        "Erro ao buscar observações da OS:",
                        observacoesResp.status,
                        t,
                    );
                }

                fotosCache = fotosData;
                observacoesCache = observacoesData;

                preencherCabecalho(osData);
                preencherGaleria(fotosData, erroFotos);
                preencherFormulario(osData);
                selecionarEtapaAtual(osData);
                selecionarEtapaObservacao(osData);
                await carregarTimeline();
            } catch (err) {
                console.error("Erro inesperado ao carregar detalhes da OS:", err);
                erroBox.classList.remove("hidden");
            }
        }

        async function recarregarFotos() {
            const fotosUrl = `/api/fotos-os/?os=${osId}`;

            try {
                const resp = await apiFetch(fotosUrl);
                if (!resp.ok) {
                    const texto = await resp.text();
                    console.error("Erro ao recarregar fotos:", resp.status, texto);
                    mostrarUploadFeedback(`Erro ${resp.status}: ${texto}`, false);
                    return;
                }

                const raw = await resp.json();
                let fotosData = [];

                if (Array.isArray(raw.results)) {
                    fotosData = raw.results;
                } else if (Array.isArray(raw)) {
                    fotosData = raw;
                }

                fotosCache = fotosData;
                preencherGaleria(fotosData, false);
            } catch (err) {
                console.error("Erro inesperado ao recarregar fotos:", err);
                mostrarUploadFeedback("Erro inesperado ao recarregar fotos", false);
            }
        }

        function selecionarEtapaObservacao(os) {
            if (!elSelectObservacaoEtapa) return;

            let etapaId = elSelectObservacaoEtapa.value;

            if (!etapaId) {
                const etapaAtual = getEtapaAtualId(os);
                const primeiraComObs = observacoesCache.length ? obterIdEtapa(observacoesCache[0]) : null;
                const primeiraEtapa = etapasCache.length ? etapasCache[0].id : null;

                etapaId = etapaAtual ?? primeiraComObs ?? primeiraEtapa ?? "";
            }

            elSelectObservacaoEtapa.value = etapaId ? String(etapaId) : "";
            atualizarTextareaObservacao();
        }

        function atualizarTextareaObservacao() {
            if (!elTextareaObservacaoEtapa || !elSelectObservacaoEtapa) return;

            const etapaSelecionada = elSelectObservacaoEtapa.value;
            const etapaId = etapaSelecionada === "" ? null : Number(etapaSelecionada);

            const existente = observacoesCache.find((obs) => Number(obterIdEtapa(obs)) === etapaId);
            elTextareaObservacaoEtapa.value = existente ? existente.texto || "" : "";
        }

        function atualizarObservacoesCache(item) {
            const etapaId = Number(obterIdEtapa(item));
            const idx = observacoesCache.findIndex((obs) => Number(obterIdEtapa(obs)) === etapaId);

            if (idx >= 0) {
                observacoesCache[idx] = item;
            } else {
                observacoesCache.push(item);
            }
        }

        function preencherCabecalho(os) {
            elCodigo.textContent = `OS ${os.codigo || os.id || ""}`.trim();
            elPlacaModelo.textContent = `${os.placa || "-"} • ${os.modelo_veiculo || ""}`.trim();
            elCliente.textContent = `${os.nome_cliente || "-"}  •  ${os.telefone_cliente || ""}`.trim();

            elEtapa.textContent = os.etapa_atual_nome || "-";

            const statusTexto = os.aberta ? "Aberta" : "Fechada";
            elStatus.textContent = statusTexto;
            elStatus.className = "";
            elStatus.classList.add("font-medium", "text-xs", "px-2", "py-0.5", "rounded-full", "border");
            if (os.aberta) {
                elStatus.classList.add("bg-emerald-600/20", "text-emerald-300", "border-emerald-500/40");
            } else {
                elStatus.classList.add("bg-slate-700/40", "text-slate-200", "border-slate-600/50");
            }

            elDataEntrada.textContent = formatarData(os.data_entrada);
            elDataPrevista.textContent = formatarData(os.data_prevista_entrega);
            elDataSaida.textContent = formatarData(os.data_saida);
        }

        function preencherFormulario(os) {
            elEditDataEntrega.value = dataParaInput(os.data_prevista_entrega);
            elEditDataSaida.value = dataParaInput(os.data_saida);
            elEditStatus.value = os.aberta ? "aberta" : "fechada";
        }

        function preencherTimeline() {
            elTimeline.innerHTML = "";

            const itens = [...timelineCache].sort((a, b) => {
                const ordemA = a.ordem ?? 0;
                const ordemB = b.ordem ?? 0;
                if (ordemA !== ordemB) return ordemA - ordemB;
                return (a.etapa ?? 0) - (b.etapa ?? 0);
            });

            if (!itens.length) {
                elTimelineVazio.classList.remove("hidden");
                return;
            }

            elTimelineVazio.classList.add("hidden");

            itens.forEach((item) => {
                const li = document.createElement("li");
                li.className = "mb-3 ml-1";

                const badgeBase = "inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-semibold";
                const badgeClass =
                    item.status === "concluida"
                        ? "bg-emerald-500/20 text-emerald-200 border border-emerald-600/60"
                        : "bg-amber-500/20 text-amber-200 border border-amber-600/60";

                const titulo = document.createElement("p");
                titulo.className = "text-[11px] font-semibold text-slate-100 flex items-center gap-2";
                titulo.textContent = item.etapa_nome || `Etapa ${item.etapa}`;

                const badge = document.createElement("span");
                badge.className = `${badgeBase} ${badgeClass}`;
                badge.textContent = item.status === "concluida" ? "Concluída" : "Pendente";
                titulo.appendChild(badge);

                if (item.is_atual) {
                    const atual = document.createElement("span");
                    atual.className = "bg-indigo-500/20 text-indigo-100 border border-indigo-600/60 px-2 py-1 rounded-full text-[10px] font-semibold";
                    atual.textContent = "Atual";
                    titulo.appendChild(atual);
                }

                const conteudo = document.createElement("div");
                conteudo.className = "ml-3 flex flex-col gap-1";
                conteudo.appendChild(titulo);

                const info = document.createElement("p");
                info.className = "text-[10px] text-slate-400";
                info.textContent = item.concluida_em
                    ? `Concluída em ${formatarDataHora(item.concluida_em)}`
                    : "Ainda pendente";
                conteudo.appendChild(info);

                const actions = document.createElement("div");
                actions.className = "flex gap-2";

                if (item.status === "pendente") {
                    const btnConcluir = document.createElement("button");
                    btnConcluir.type = "button";
                    btnConcluir.textContent = "Marcar concluída";
                    btnConcluir.className =
                        "px-2 py-1 rounded-full text-[10px] font-semibold bg-emerald-600/80 hover:bg-emerald-500 text-white transition disabled:opacity-60";
                    btnConcluir.addEventListener("click", () => marcarEtapa(item.etapa, btnConcluir));
                    actions.appendChild(btnConcluir);
                }

                if (item.status === "concluida") {
                    const btnReabrir = document.createElement("button");
                    btnReabrir.type = "button";
                    btnReabrir.textContent = "Reabrir";
                    btnReabrir.className =
                        "px-2 py-1 rounded-full text-[10px] font-semibold bg-amber-600/80 hover:bg-amber-500 text-white transition disabled:opacity-60";
                    btnReabrir.addEventListener("click", () => reabrirEtapa(item.etapa, btnReabrir));
                    actions.appendChild(btnReabrir);
                }

                conteudo.appendChild(actions);

                const wrapper = document.createElement("div");
                wrapper.className = "relative";
                const dotBase = "absolute -left-2.5 w-2 h-2 rounded-full border border-slate-900";
                const dotColor = item.status === "concluida" ? "bg-emerald-400" : "bg-amber-400";
                const dot = document.createElement("span");
                dot.className = `${dotBase} ${dotColor}`;

                wrapper.appendChild(dot);
                wrapper.appendChild(conteudo);
                li.appendChild(wrapper);

                elTimeline.appendChild(li);
            });
        }

        function criarBotaoExcluirFoto(fotoId) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = "Excluir";
            btn.dataset.fotoId = fotoId;
            btn.className = "mt-1 px-2 py-1 rounded-full text-[10px] font-semibold bg-rose-600/80 hover:bg-rose-500 text-white transition disabled:opacity-60";

            btn.addEventListener("click", async () => {
                if (!confirm("Excluir esta foto?")) return;

                btn.disabled = true;
                const textoOriginal = btn.textContent;
                btn.textContent = "Excluindo...";

                try {
                    const resp = await apiFetch(`/api/fotos-os/${fotoId}/`, { method: "DELETE" });

                    if (resp && resp.ok) {
                        alert("Foto excluída");
                        await recarregarFotos();
                        return;
                    }

                    const erroTexto = resp ? await resp.text() : "Resposta vazia";
                    alert(`Erro ${resp ? resp.status : ""}: ${erroTexto}`);
                } catch (err) {
                    console.error("Erro ao excluir foto:", err);
                    alert("Erro ao excluir foto: " + (err?.message || err));
                } finally {
                    btn.disabled = false;
                    btn.textContent = textoOriginal;
                }
            });

            return btn;
        }

        function preencherGaleria(fotos, fotosErro = false) {
            elFotosContainer.innerHTML = "";

            if (fotosErro) {
                elFotosVazio.textContent = "Falha ao carregar fotos";
                elFotosVazio.classList.remove("hidden");
                elFotosCount.textContent = "—";
                return;
            }

            elFotosVazio.textContent = mensagemFotosPadrao;

            if (!fotos || !fotos.length) {
                elFotosVazio.classList.remove("hidden");
                elFotosCount.textContent = "0 fotos";
                return;
            }

            elFotosVazio.classList.add("hidden");
            elFotosCount.textContent = `${fotos.length} foto${fotos.length > 1 ? "s" : ""}`;

            // Agrupa por etapa
            const grupos = {};
            fotos.forEach((f) => {
                const etapa = f.etapa_nome || "Outras fotos";
                if (!grupos[etapa]) {
                    grupos[etapa] = [];
                }
                grupos[etapa].push(f);
            });

            Object.keys(grupos).forEach((etapa) => {
                const bloco = document.createElement("div");
                bloco.className = "border border-slate-800 rounded-2xl p-3";

                const titulo = document.createElement("h4");
                titulo.className = "text-[11px] font-semibold text-slate-200 uppercase tracking-wide mb-2";
                titulo.textContent = etapa;

                const grid = document.createElement("div");
                grid.className = "grid grid-cols-2 md:grid-cols-3 gap-2";

                grupos[etapa].forEach((f) => {
                    const card = document.createElement("div");
                    card.className = "bg-slate-950/80 border border-slate-800 rounded-xl overflow-hidden flex flex-col";

                    const thumbUrl = f.drive_thumb_url;
                    const imageWrapper = document.createElement("div");
                    imageWrapper.className = "relative w-full aspect-[4/3] bg-slate-950";

                    if (thumbUrl) {
                        const placeholder = document.createElement("div");
                        placeholder.className = "absolute inset-0 bg-slate-800 animate-pulse";
                        imageWrapper.appendChild(placeholder);

                        const img = document.createElement("img");
                        img.src = thumbUrl;
                        img.alt = f.titulo || f.observacao || "";
                        img.loading = "lazy";
                        img.className = "w-full h-full object-cover absolute inset-0 blur-sm opacity-0 transition duration-300 cursor-pointer";
                        img.addEventListener("load", () => {
                            img.classList.remove("blur-sm", "opacity-0");
                            img.classList.add("opacity-100");
                            placeholder.classList.add("hidden");
                        });

                        img.addEventListener("click", () => abrirModalImagem(f.drive_url, img.alt));

                        imageWrapper.appendChild(img);
                    } else {
                        const noImage = document.createElement("div");
                        noImage.className = "absolute inset-0 flex items-center justify-center bg-slate-900 text-[11px] text-slate-400";
                        noImage.textContent = "Sem imagem";
                        imageWrapper.appendChild(noImage);
                    }

                    const info = document.createElement("div");
                    info.className = "p-2 flex flex-col gap-1";

                    const linha1 = document.createElement("p");
                    linha1.className = "text-[11px] text-slate-100 truncate";
                    linha1.textContent = f.titulo || f.os_codigo || "Foto";

                    const linha2 = document.createElement("p");
                    linha2.className = "text-[10px] text-slate-400";
                    const quem = f.tirada_por_nome || "Usuário não identificado";
                    linha2.textContent = `${quem} • ${formatarDataHora(f.tirada_em)}`;

                    if (f.observacao) {
                        const linha3 = document.createElement("p");
                        linha3.className = "text-[10px] text-slate-500 line-clamp-2";
                        linha3.textContent = f.observacao;
                        info.appendChild(linha3);
                    }

                    info.appendChild(linha1);
                    info.appendChild(linha2);

                    const actions = document.createElement("div");
                    actions.className = "flex justify-end";
                    const btnExcluir = criarBotaoExcluirFoto(f.id);
                    actions.appendChild(btnExcluir);

                    card.appendChild(imageWrapper);
                    card.appendChild(info);
                    card.appendChild(actions);
                    grid.appendChild(card);
                });

                bloco.appendChild(titulo);
                bloco.appendChild(grid);
                elFotosContainer.appendChild(bloco);
            });
        }

        async function salvarEtapaAtual() {
            if (!elSelectEtapaAtual) return;

            const valorSelecionado = elSelectEtapaAtual.value;
            const etapaId = valorSelecionado === "" ? null : Number(valorSelecionado);

            limparEtapaFeedback();

            try {
                const resp = await apiFetch(`/api/os/${osId}/`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ etapa_atual: etapaId }),
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    mostrarEtapaFeedback(`Erro ${resp.status}: ${texto}`, false);
                    return;
                }

                const atualizado = await resp.json();
                osDadosAtuais = atualizado;
                preencherCabecalho(atualizado);
                preencherFormulario(atualizado);
                await carregarTimeline();
                selecionarEtapaAtual(atualizado);

                mostrarEtapaFeedback("Etapa atual atualizada", true);
            } catch (err) {
                console.error("Erro ao salvar etapa:", err);
                mostrarEtapaFeedback("Erro ao salvar etapa. Tente novamente.", false);
            }
        }

        async function salvarObservacaoEtapa() {
            if (!elSelectObservacaoEtapa) return;

            const etapaSelecionada = elSelectObservacaoEtapa.value;
            const etapaId = etapaSelecionada === "" ? null : Number(etapaSelecionada);

            if (!etapaId) {
                mostrarObservacaoFeedback("Selecione uma etapa", false);
                return;
            }

            limparObservacaoFeedback();

            const payload = {
                etapa: etapaId,
                texto: elTextareaObservacaoEtapa ? elTextareaObservacaoEtapa.value : "",
            };

            try {
                const resp = await apiFetch(`/api/os/${osId}/observacoes/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    mostrarObservacaoFeedback(`Erro ${resp.status}: ${texto}`, false);
                    return;
                }

                const salvo = await resp.json();
                atualizarObservacoesCache(salvo);
                atualizarTextareaObservacao();
                mostrarObservacaoFeedback("Observação salva", true);
            } catch (err) {
                console.error("Erro ao salvar observação:", err);
                mostrarObservacaoFeedback("Erro ao salvar observação. Tente novamente.", false);
            }
        }

        async function enviarFotoLivre() {
            if (!elBtnEnviarFotoLivre || !elFotoLivreInput) return;

            limparUploadFeedback();

            const file = elFotoLivreInput.files?.[0];

            if (!file) {
                mostrarUploadFeedback("Selecione uma imagem para enviar", false);
                return;
            }

            const formData = new FormData();
            formData.append("os", osId);
            formData.append("arquivo", file);

            if (elFotoLivreEtapaSelect && elFotoLivreEtapaSelect.value) {
                formData.append("etapa", elFotoLivreEtapaSelect.value);
            }

            formData.append("tipo", "LIVRE");

            elBtnEnviarFotoLivre.disabled = true;
            elBtnEnviarFotoLivre.textContent = "Enviando...";

            try {
                const resp = await apiFetch("/api/fotos-os/", {
                    method: "POST",
                    body: formData,
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    mostrarUploadFeedback(`Erro ${resp.status}: ${texto}`, false);
                    return;
                }

                await resp.json();
                mostrarUploadFeedback("Foto enviada", true);

                if (elFotoLivreInput) {
                    elFotoLivreInput.value = "";
                }
                if (elFotoLivreEtapaSelect) {
                    elFotoLivreEtapaSelect.value = "";
                }

                await recarregarFotos();
            } catch (err) {
                console.error("Erro ao enviar foto livre:", err);
                mostrarUploadFeedback("Erro ao enviar foto. Tente novamente.", false);
            } finally {
                elBtnEnviarFotoLivre.disabled = false;
                elBtnEnviarFotoLivre.textContent = "Enviar foto";
            }
        }

        async function salvarEdicao() {
            const payload = {};

            if (elEditDataEntrega) {
                payload.data_prevista_entrega = elEditDataEntrega.value || null;
            }
            if (elEditDataSaida) {
                payload.data_saida = elEditDataSaida.value || null;
            }
            if (elEditStatus) {
                payload.aberta = elEditStatus.value === "aberta";
            }

            toggleSalvando(true);

            try {
                const resp = await apiFetch(`/api/os/${osId}/`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (!resp.ok) {
                    const texto = await resp.text();
                    alert(`Erro ao salvar (${resp.status}): ${texto}`);
                    return;
                }

                const atualizado = await resp.json();
                osDadosAtuais = atualizado;
                preencherCabecalho(atualizado);
                preencherFormulario(atualizado);
                await carregarTimeline();

                alert("Salvo com sucesso");
            } catch (err) {
                console.error("Erro ao salvar alterações da OS:", err);
                alert("Erro ao salvar alterações. Tente novamente.");
            } finally {
                toggleSalvando(false);
            }
        }

        if (elBtnVoltarEtapa) {
            elBtnVoltarEtapa.addEventListener("click", () => moverEtapaAtual(-1));
        }

        if (elBtnAvancarEtapa) {
            elBtnAvancarEtapa.addEventListener("click", () => moverEtapaAtual(1));
        }

        if (elBtnSalvarEtapa) {
            elBtnSalvarEtapa.addEventListener("click", salvarEtapaAtual);
        }

        if (elSelectEtapaAtual) {
            elSelectEtapaAtual.addEventListener("change", limparEtapaFeedback);
        }

        if (elBtnSalvarObservacao) {
            elBtnSalvarObservacao.addEventListener("click", salvarObservacaoEtapa);
        }

        if (elSelectObservacaoEtapa) {
            elSelectObservacaoEtapa.addEventListener("change", () => {
                limparObservacaoFeedback();
                atualizarTextareaObservacao();
            });
        }

        if (elBtnEnviarFotoLivre) {
            elBtnEnviarFotoLivre.addEventListener("click", enviarFotoLivre);
        }

        if (elFotoLivreInput) {
            elFotoLivreInput.addEventListener("change", () => limparUploadFeedback());
        }

        elEditSalvar.addEventListener("click", salvarEdicao);

        carregarDados();
    })();
});
</script>

{% endblock %}
