{% extends "painel/base.html" %}
{% load static %}

{% block title %}CheckAuto - Configurar Etapas{% endblock %}

{% block page_title %}
Configurar Etapas
{% endblock %}

{% block page_subtitle %}
Defina as etapas do processo e quais aparecem no dashboard.
{% endblock %}

{% block content %}

<script src="{% static 'painel/js/auth.js' %}"></script>
<script src="{% static 'painel/js/api.js' %}"></script>

<div id="etapas-erro" class="hidden mb-4 bg-rose-900/40 border border-rose-700/70 text-rose-100 text-xs rounded-xl px-3 py-2">
    Ocorreu um erro ao carregar ou salvar as etapas. Veja o console para detalhes.
</div>

<!-- Formulário simples para criar/editar etapa -->
<div class="mb-4 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
    <h2 class="text-xs font-semibold text-slate-200 uppercase tracking-wide mb-2">
        Nova etapa / Editar etapa
    </h2>

    <form id="form-etapa" class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
        <input type="hidden" id="etapa-id">

        <div class="flex flex-col gap-1">
            <label for="etapa-nome" class="text-[11px] text-slate-400 uppercase tracking-wide">
                Nome da etapa
            </label>
            <input
                id="etapa-nome"
                type="text"
                required
                placeholder="Ex: Funilaria, Pintura..."
                class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                       placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
        </div>

        <div class="flex flex-col gap-1">
            <label for="etapa-ordem" class="text-[11px] text-slate-400 uppercase tracking-wide">
                Ordem
            </label>
            <input
                id="etapa-ordem"
                type="number"
                min="0"
                step="1"
                placeholder="0, 1, 2..."
                class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                       placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-[11px] text-slate-400 uppercase tracking-wide">
                Opções
            </label>
            <div class="flex flex-col gap-1 mt-1">
                <label class="inline-flex items-center gap-2">
                    <input id="etapa-mostrar-dashboard" type="checkbox" class="rounded border-slate-600 bg-slate-900">
                    <span class="text-[11px] text-slate-300">Mostrar no dashboard</span>
                </label>
                <label class="inline-flex items-center gap-2">
                    <input id="etapa-ativa" type="checkbox" class="rounded border-slate-600 bg-slate-900" checked>
                    <span class="text-[11px] text-slate-300">Etapa ativa</span>
                </label>
            </div>
        </div>

        <div class="flex flex-col gap-2 justify-end">
            <button
                type="submit"
                class="inline-flex items-center justify-center w-full md:w-auto px-4 py-2 rounded-xl text-xs font-medium
                       bg-indigo-600 hover:bg-indigo-500 text-white transition"
            >
                Salvar etapa
            </button>
            <button
                type="button"
                id="btn-etapa-cancelar"
                class="inline-flex items-center justify-center w-full md:w-auto px-4 py-2 rounded-xl text-xs
                       border border-slate-700 text-slate-300 hover:bg-slate-800/70 transition"
            >
                Limpar formulário
            </button>
        </div>
    </form>
</div>

<!-- Tabela de etapas -->
<div class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
    <div class="border-b border-slate-800 px-4 py-2 flex items-center justify-between">
        <p class="text-xs text-slate-400">
            Etapas configuradas para esta oficina.
        </p>
        <p id="etapas-count" class="text-[11px] text-slate-500">
            —
        </p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
                <tr>
                    <th class="px-3 py-2 text-left">Ordem</th>
                    <th class="px-3 py-2 text-left">Nome</th>
                    <th class="px-3 py-2 text-left">Dashboard</th>
                    <th class="px-3 py-2 text-left">Ativa</th>
                    <th class="px-3 py-2 text-right">Ações</th>
                </tr>
            </thead>
            <tbody id="etapas-tbody" class="divide-y divide-slate-800/80">
                <!-- linhas preenchidas via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const erroBox = document.getElementById("etapas-erro");

    const ok = await verificarAutenticacao();
    if (!ok) return;

    const tbody = document.getElementById("etapas-tbody");
    const countLabel = document.getElementById("etapas-count");

    // Form
    const form = document.getElementById("form-etapa");
    const inputId = document.getElementById("etapa-id");
    const inputNome = document.getElementById("etapa-nome");
    const inputOrdem = document.getElementById("etapa-ordem");
    const inputMostrarDashboard = document.getElementById("etapa-mostrar-dashboard");
    const inputAtiva = document.getElementById("etapa-ativa");
    const btnCancelar = document.getElementById("btn-etapa-cancelar");

    function limparFormulario() {
        inputId.value = "";
        inputNome.value = "";
        inputOrdem.value = "";
        inputMostrarDashboard.checked = false;
        inputAtiva.checked = true;
    }

    btnCancelar.addEventListener("click", (e) => {
        e.preventDefault();
        limparFormulario();
    });

    function carregarEtapas() {
        apiFetch("/api/etapas/", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao listar etapas:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;

            let lista = data;
            if (Array.isArray(data.results)) {
                lista = data.results;
            }

            tbody.innerHTML = "";

            if (!lista || !lista.length) {
                countLabel.textContent = "Nenhuma etapa configurada.";
                return;
            }

            countLabel.textContent = `${lista.length} etapa${lista.length > 1 ? "s" : ""}`;
            lista.forEach(etapa => {
                adicionarLinhaEtapa(etapa);
            });
        })
        .catch((err) => {
            console.error("Erro inesperado ao listar etapas:", err);
            erroBox.classList.remove("hidden");
        });
    }

    function adicionarLinhaEtapa(etapa) {
        const tr = document.createElement("tr");
        tr.dataset.id = etapa.id;
        tr.className = "hover:bg-slate-900";

        const marcarSimNao = (valor) => valor ? "Sim" : "Não";

        tr.innerHTML = `
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${etapa.ordem ?? ""}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${etapa.nome ?? ""}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                <span class="inline-flex items-center gap-1 text-[11px]">
                    <span class="w-2 h-2 rounded-full ${etapa.mostrar_no_dashboard ? "bg-emerald-400" : "bg-slate-600"}"></span>
                    ${marcarSimNao(etapa.mostrar_no_dashboard)}
                </span>
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                <span class="inline-flex items-center gap-1 text-[11px]">
                    <span class="w-2 h-2 rounded-full ${etapa.ativa ? "bg-emerald-400" : "bg-rose-400"}"></span>
                    ${marcarSimNao(etapa.ativa)}
                </span>
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-right">
                <button
                    type="button"
                    class="btn-etapa-editar inline-flex items-center px-3 py-1 rounded-lg border border-slate-700
                           text-[11px] text-slate-100 hover:bg-slate-800/80 mr-1">
                    Editar
                </button>
            </td>
        `;

        const btnEditar = tr.querySelector(".btn-etapa-editar");
        btnEditar.addEventListener("click", () => {
            preencherFormularioParaEdicao(etapa);
        });

        tbody.appendChild(tr);
    }

    function preencherFormularioParaEdicao(etapa) {
        inputId.value = etapa.id;
        inputNome.value = etapa.nome ?? "";
        inputOrdem.value = etapa.ordem ?? "";
        inputMostrarDashboard.checked = !!etapa.mostrar_no_dashboard;
        inputAtiva.checked = !!etapa.ativa;
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const payload = {
            nome: inputNome.value.trim(),
            ordem: inputOrdem.value ? parseInt(inputOrdem.value, 10) : null,
            mostrar_no_dashboard: inputMostrarDashboard.checked,
            ativa: inputAtiva.checked,
        };


        if (!payload.nome) {
            alert("Informe o nome da etapa.");
            return;
        }

        const id = inputId.value;
        const isEdicao = Boolean(id);

        let url = "/api/etapas/";
        let method = "POST";

        if (isEdicao) {
            url = `/api/etapas/${id}/`;
            method = "PATCH";
        }

        apiFetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
            },
            body: payload,
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao salvar etapa:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;
            limparFormulario();
            carregarEtapas();
            erroBox.classList.add("hidden");
        })
        .catch((err) => {
            console.error("Erro inesperado ao salvar etapa:", err);
            erroBox.classList.remove("hidden");
        });
    });

    carregarEtapas();
});
</script>

{% endblock %}
