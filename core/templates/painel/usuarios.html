{% extends "painel/base.html" %}

{% block title %}CheckAuto - Usuários do Sistema{% endblock %}

{% block page_title %}
Usuários do sistema
{% endblock %}

{% block page_subtitle %}
Gerencie quem tem acesso à sua oficina no CheckAuto.
{% endblock %}

{% block content %}

<div id="usuarios-erro" class="hidden mb-4 bg-rose-900/40 border border-rose-700/70 text-rose-100 text-xs rounded-xl px-3 py-2">
    Ocorreu um erro ao carregar ou atualizar os usuários. Veja o console para detalhes.
</div>

<div class="mb-4 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
    <h2 class="text-xs font-semibold text-slate-200 uppercase tracking-wide mb-2">
        Como funciona
    </h2>
    <p class="text-[11px] text-slate-300 mb-1">
        Esta lista mostra os usuários vinculados à sua oficina (<code>UsuarioOficina</code>).
    </p>
    <p class="text-[11px] text-slate-400 mb-1">
        Você pode ativar ou desativar o acesso ao sistema para cada usuário.
    </p>
    <p class="text-[11px] text-slate-500">
        A inclusão de novos usuários ainda é feita via painel administrativo (Django admin).
    </p>
</div>

<div class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
    <div class="border-b border-slate-800 px-4 py-2 flex items-center justify-between">
        <p class="text-xs text-slate-400">
            Usuários vinculados à oficina.
        </p>
        <p id="usuarios-count" class="text-[11px] text-slate-500">
            —
        </p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
                <tr>
                    <th class="px-3 py-2 text-left">Nome</th>
                    <th class="px-3 py-2 text-left">Usuário</th>
                    <th class="px-3 py-2 text-left">Papel</th>
                    <th class="px-3 py-2 text-left">Ativo</th>
                    <th class="px-3 py-2 text-left">Desde</th>
                    <th class="px-3 py-2 text-right">Ações</th>
                </tr>
            </thead>
            <tbody id="usuarios-tbody" class="divide-y divide-slate-800/80">
                <!-- linhas preenchidas via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const TOKEN_KEY = "checkauto_token";
    const token = window.localStorage.getItem(TOKEN_KEY);
    const erroBox = document.getElementById("usuarios-erro");

    if (!token) {
        erroBox.classList.remove("hidden");
        erroBox.textContent = "⚠ Não foi encontrado token (checkauto_token). Faça login para gerenciar os usuários.";
        return;
    }

    const tbody = document.getElementById("usuarios-tbody");
    const countLabel = document.getElementById("usuarios-count");

    function formatarData(dataStr) {
        if (!dataStr) return "-";
        const apenasData = dataStr.split("T")[0];
        const partes = apenasData.split("-");
        if (partes.length === 3) {
            return partes[2] + "/" + partes[1] + "/" + partes[0];
        }
        return apenasData;
    }

    function carregarUsuarios() {
        fetch("/api/usuarios-oficina/", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao listar usuarios-oficina:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;

            let lista = data;
            if (Array.isArray(data.results)) {
                lista = data.results;
            }

            tbody.innerHTML = "";

            if (!lista || !lista.length) {
                countLabel.textContent = "Nenhum usuário vinculado.";
                return;
            }

            countLabel.textContent = `${lista.length} usuário${lista.length > 1 ? "s" : ""}`;
            lista.forEach(u => adicionarLinhaUsuario(u));
            erroBox.classList.add("hidden");
        })
        .catch((err) => {
            console.error("Erro inesperado ao listar usuarios-oficina:", err);
            erroBox.classList.remove("hidden");
        });
    }

    function adicionarLinhaUsuario(usuario) {
        const tr = document.createElement("tr");
        tr.dataset.id = usuario.id;
        tr.className = "hover:bg-slate-900";

        const ativo = !!usuario.ativo;
        const papel = usuario.papel || "-";

        const badgeAtivoClasse = ativo ? "bg-emerald-600/20 text-emerald-300 border-emerald-500/40"
                                       : "bg-rose-600/20 text-rose-200 border-rose-500/40";
        const badgeAtivoTexto = ativo ? "Ativo" : "Inativo";
        const botaoTexto = ativo ? "Desativar" : "Ativar";

        tr.innerHTML = `
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${usuario.user_nome || "-"}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-slate-300">
                ${usuario.user_username || "-"}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-slate-300">
                ${papel}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[11px] ${badgeAtivoClasse}">
                    ${badgeAtivoTexto}
                </span>
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-slate-400">
                ${formatarData(usuario.criado_em)}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-right">
                <button
                    type="button"
                    class="btn-usuario-toggle inline-flex items-center px-3 py-1 rounded-lg border border-slate-700
                           text-[11px] text-slate-100 hover:bg-slate-800/80">
                    ${botaoTexto}
                </button>
            </td>
        `;

        const btnToggle = tr.querySelector(".btn-usuario-toggle");
        btnToggle.addEventListener("click", () => {
            atualizarAtivoUsuario(usuario.id, !ativo);
        });

        tbody.appendChild(tr);
    }

    function atualizarAtivoUsuario(id, novoValor) {
        fetch(`/api/usuarios-oficina/${id}/`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({ ativo: novoValor }),
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao atualizar usuario-oficina:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;
            // Recarrega a lista para refletir o novo status
            carregarUsuarios();
            erroBox.classList.add("hidden");
        })
        .catch((err) => {
            console.error("Erro inesperado ao atualizar usuario-oficina:", err);
            erroBox.classList.remove("hidden");
        });
    }

    carregarUsuarios();
});
</script>

{% endblock %}
