{% extends "painel/base.html" %}

{% block title %}CheckAuto - Configurar Fotos{% endblock %}

{% block page_title %}
Configurar Fotos
{% endblock %}

{% block page_subtitle %}
Defina quais fotos devem ser tiradas em cada etapa e se são obrigatórias.
{% endblock %}

{% block content %}

<div id="cfgfotos-erro" class="hidden mb-4 bg-rose-900/40 border border-rose-700/70 text-rose-100 text-xs rounded-xl px-3 py-2">
    Ocorreu um erro ao carregar ou salvar as configurações de fotos. Veja o console para detalhes.
</div>

<!-- Formulário de criação/edição -->
<div class="mb-4 bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
    <h2 class="text-xs font-semibold text-slate-200 uppercase tracking-wide mb-2">
        Nova configuração / Editar configuração
    </h2>

    <form id="form-config-foto" class="grid grid-cols-1 md:grid-cols-4 gap-3 text-xs">
        <input type="hidden" id="cfgfoto-id">

        <!-- Etapa -->
        <div class="flex flex-col gap-1">
            <label for="cfgfoto-etapa" class="text-[11px] text-slate-400 uppercase tracking-wide">
                Etapa
            </label>
            <select
                id="cfgfoto-etapa"
                required
                class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                       focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
                <option value="">Selecione a etapa...</option>
            </select>
        </div>

        <!-- Nome -->
        <div class="flex flex-col gap-1">
            <label for="cfgfoto-nome" class="text-[11px] text-slate-400 uppercase tracking-wide">
                Nome da foto
            </label>
            <input
                id="cfgfoto-nome"
                type="text"
                required
                placeholder="Ex: Dianteira, Traseira, Painel ligado..."
                class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                       placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
        </div>

        <!-- Ordem -->
        <div class="flex flex-col gap-1">
            <label for="cfgfoto-ordem" class="text-[11px] text-slate-400 uppercase tracking-wide">
                Ordem
            </label>
            <input
                id="cfgfoto-ordem"
                type="number"
                min="0"
                step="1"
                placeholder="0, 1, 2..."
                class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                       placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
        </div>

        <!-- Checkboxes -->
        <div class="flex flex-col gap-1">
            <label class="text-[11px] text-slate-400 uppercase tracking-wide">
                Opções
            </label>
            <div class="flex flex-col gap-1 mt-1">
                <label class="inline-flex items-center gap-2">
                    <input id="cfgfoto-obrigatoria" type="checkbox" class="rounded border-slate-600 bg-slate-900">
                    <span class="text-[11px] text-slate-300">Obrigatória</span>
                </label>
                <label class="inline-flex items-center gap-2">
                    <input id="cfgfoto-ativa" type="checkbox" class="rounded border-slate-600 bg-slate-900" checked>
                    <span class="text-[11px] text-slate-300">Configuração ativa</span>
                </label>
            </div>
        </div>

        <!-- Descrição + botões -->
        <div class="md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
            <div class="md:col-span-2 flex flex-col gap-1">
                <label for="cfgfoto-descricao" class="text-[11px] text-slate-400 uppercase tracking-wide">
                    Descrição (opcional)
                </label>
                <textarea
                    id="cfgfoto-descricao"
                    rows="2"
                    placeholder="Algum detalhe extra sobre a foto..."
                    class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                           placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                ></textarea>
            </div>

            <div class="flex flex-col gap-2 justify-end">
                <button
                    type="submit"
                    class="inline-flex items-center justify-center w-full md:w-auto px-4 py-2 rounded-xl text-xs font-medium
                           bg-indigo-600 hover:bg-indigo-500 text-white transition"
                >
                    Salvar configuração
                </button>
                <button
                    type="button"
                    id="btn-cfgfoto-cancelar"
                    class="inline-flex items-center justify-center w-full md:w-auto px-4 py-2 rounded-xl text-xs
                           border border-slate-700 text-slate-300 hover:bg-slate-800/70 transition"
                >
                    Limpar formulário
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Filtro por etapa + tabela -->
<div class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
    <div class="border-b border-slate-800 px-4 py-2 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-[11px] text-slate-300">
            <span>Filtrar por etapa:</span>
            <select
                id="filtro-etapa"
                class="bg-slate-950 border border-slate-700 rounded-lg px-2 py-1 text-[11px] text-slate-100"
            >
                <option value="">Todas</option>
            </select>
        </div>
        <p id="cfgfotos-count" class="text-[11px] text-slate-500">
            —
        </p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
                <tr>
                    <th class="px-3 py-2 text-left">Etapa</th>
                    <th class="px-3 py-2 text-left">Nome da foto</th>
                    <th class="px-3 py-2 text-left">Obrigatória</th>
                    <th class="px-3 py-2 text-left">Ativa</th>
                    <th class="px-3 py-2 text-left">Ordem</th>
                    <th class="px-3 py-2 text-right">Ações</th>
                </tr>
            </thead>
            <tbody id="cfgfotos-tbody" class="divide-y divide-slate-800/80">
                <!-- preenchido via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const TOKEN_KEY = "checkauto_token";
    const token = window.localStorage.getItem(TOKEN_KEY);
    const erroBox = document.getElementById("cfgfotos-erro");

    if (!token) {
        erroBox.classList.remove("hidden");
        erroBox.textContent = "⚠ Não foi encontrado token (checkauto_token). Faça login para configurar as fotos.";
        return;
    }

    const tbody = document.getElementById("cfgfotos-tbody");
    const countLabel = document.getElementById("cfgfotos-count");

    // selects de etapa
    const selectEtapaForm = document.getElementById("cfgfoto-etapa");
    const selectEtapaFiltro = document.getElementById("filtro-etapa");

    // form
    const form = document.getElementById("form-config-foto");
    const inputId = document.getElementById("cfgfoto-id");
    const inputNome = document.getElementById("cfgfoto-nome");
    const inputOrdem = document.getElementById("cfgfoto-ordem");
    const inputObrigatoria = document.getElementById("cfgfoto-obrigatoria");
    const inputAtiva = document.getElementById("cfgfoto-ativa");
    const inputDescricao = document.getElementById("cfgfoto-descricao");
    const btnCancelar = document.getElementById("btn-cfgfoto-cancelar");

    function limparFormulario() {
        inputId.value = "";
        selectEtapaForm.value = "";
        inputNome.value = "";
        inputOrdem.value = "";
        inputObrigatoria.checked = false;
        inputAtiva.checked = true;
        inputDescricao.value = "";
    }

    btnCancelar.addEventListener("click", (e) => {
        e.preventDefault();
        limparFormulario();
    });

    function carregarEtapasParaSelects() {
        fetch("/api/etapas/", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao listar etapas (Config Fotos):", resp.status, t);
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;
            let lista = data;
            if (Array.isArray(data.results)) {
                lista = data.results;
            }
            selectEtapaForm.innerHTML = '<option value="">Selecione a etapa...</option>';
            selectEtapaFiltro.innerHTML = '<option value="">Todas</option>';

            lista.forEach(etapa => {
                const opt1 = document.createElement("option");
                opt1.value = etapa.id;
                opt1.textContent = `${etapa.ordem ?? ""} - ${etapa.nome}`;
                selectEtapaForm.appendChild(opt1);

                const opt2 = document.createElement("option");
                opt2.value = etapa.id;
                opt2.textContent = `${etapa.ordem ?? ""} - ${etapa.nome}`;
                selectEtapaFiltro.appendChild(opt2);
            });
        })
        .catch((err) => {
            console.error("Erro inesperado ao carregar etapas:", err);
        });
    }

    function montarUrlConfigFotos() {
        const base = "/api/config-fotos/";
        const etapaId = selectEtapaFiltro.value;
        if (etapaId) {
            return `${base}?etapa=${etapaId}`;
        }
        return base;
    }

    function carregarConfigFotos() {
        const url = montarUrlConfigFotos();

        fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao listar config-fotos:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;

            let lista = data;
            if (Array.isArray(data.results)) {
                lista = data.results;
            }

            tbody.innerHTML = "";

            if (!lista || !lista.length) {
                countLabel.textContent = "Nenhuma configuração encontrada.";
                return;
            }

            countLabel.textContent = `${lista.length} configuração${lista.length > 1 ? "es" : ""}`;
            lista.forEach(cfg => adicionarLinha(cfg));
            erroBox.classList.add("hidden");
        })
        .catch((err) => {
            console.error("Erro inesperado ao listar config-fotos:", err);
            erroBox.classList.remove("hidden");
        });
    }

    function adicionarLinha(cfg) {
        const tr = document.createElement("tr");
        tr.dataset.id = cfg.id;
        tr.className = "hover:bg-slate-900";

        const marcarSimNao = (v) => v ? "Sim" : "Não";

        tr.innerHTML = `
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${cfg.etapa_nome ?? "-"}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${cfg.nome ?? ""}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                <span class="inline-flex items-center gap-1 text-[11px]">
                    <span class="w-2 h-2 rounded-full ${cfg.obrigatoria ? "bg-amber-400" : "bg-slate-600"}"></span>
                    ${marcarSimNao(cfg.obrigatoria)}
                </span>
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                <span class="inline-flex items-center gap-1 text-[11px]">
                    <span class="w-2 h-2 rounded-full ${cfg.ativa ? "bg-emerald-400" : "bg-rose-400"}"></span>
                    ${marcarSimNao(cfg.ativa)}
                </span>
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap">
                ${cfg.ordem ?? ""}
            </td>
            <td class="px-3 py-2 align-middle whitespace-nowrap text-right">
                <button
                    type="button"
                    class="btn-cfgfoto-editar inline-flex items-center px-3 py-1 rounded-lg border border-slate-700
                           text-[11px] text-slate-100 hover:bg-slate-800/80 mr-1">
                    Editar
                </button>
            </td>
        `;

        tr.querySelector(".btn-cfgfoto-editar").addEventListener("click", () => {
            preencherFormulario(cfg);
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        tbody.appendChild(tr);
    }

    function preencherFormulario(cfg) {
        inputId.value = cfg.id;
        selectEtapaForm.value = cfg.etapa ?? "";
        inputNome.value = cfg.nome ?? "";
        inputOrdem.value = cfg.ordem ?? "";
        inputObrigatoria.checked = !!cfg.obrigatoria;
        inputAtiva.checked = !!cfg.ativa;
        inputDescricao.value = cfg.descricao ?? "";
    }

    selectEtapaFiltro.addEventListener("change", () => {
        carregarConfigFotos();
    });

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const etapaId = selectEtapaForm.value;
        if (!etapaId) {
            alert("Selecione uma etapa.");
            return;
        }

        const payload = {
            etapa: parseInt(etapaId, 10),
            nome: inputNome.value.trim(),
            ordem: inputOrdem.value ? parseInt(inputOrdem.value, 10) : null,
            obrigatoria: inputObrigatoria.checked,
            ativa: inputAtiva.checked,
            descricao: inputDescricao.value.trim() || null,
        };

        if (!payload.nome) {
            alert("Informe o nome da foto.");
            return;
        }

        const id = inputId.value;
        const isEdicao = Boolean(id);

        let url = "/api/config-fotos/";
        let method = "POST";

        if (isEdicao) {
            url = `/api/config-fotos/${id}/`;
            method = "PATCH";
        }

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
        })
        .then(async (resp) => {
            if (!resp.ok) {
                const t = await resp.text();
                console.error("Erro ao salvar config-foto:", resp.status, t);
                erroBox.classList.remove("hidden");
                return null;
            }
            return resp.json();
        })
        .then((data) => {
            if (!data) return;
            limparFormulario();
            carregarConfigFotos();
            erroBox.classList.add("hidden");
        })
        .catch((err) => {
            console.error("Erro inesperado ao salvar config-foto:", err);
            erroBox.classList.remove("hidden");
        });
    });

    carregarEtapasParaSelects();
    carregarConfigFotos();
});
</script>

{% endblock %}
