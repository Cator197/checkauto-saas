{% extends "painel/base.html" %}

{% block title %}CheckAuto - Ordens de Serviço{% endblock %}

{% block page_title %}
Ordens de Serviço
{% endblock %}

{% block page_subtitle %}
Visualize e filtre todas as OS da sua oficina.
{% endblock %}

{% block content %}

    <!-- Filtros / barra de busca -->
    <div class="mb-4 flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div class="flex-1 flex flex-col gap-2 md:max-w-md">
            <label class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">
                Buscar
            </label>
            <input
                id="filtro-search"
                type="text"
                placeholder="Buscar por código, placa ou nome do cliente..."
                class="w-full bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 text-sm text-slate-100
                       placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
        </div>

        <div class="flex flex-wrap gap-3">
            <!-- Status -->
            <div class="flex flex-col gap-1">
                <label class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">
                    Status
                </label>
                <select
                    id="filtro-status"
                    class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                           focus:outline-none focus:ring-1 focus:ring-indigo-500"
                >
                    <option value="">Todos</option>
                    <option value="aberta">Apenas abertas</option>
                    <option value="fechada">Apenas fechadas</option>
                </select>
            </div>

            <!-- Etapa (vamos preencher via JS ou por enquanto deixar manual) -->
            <div class="flex flex-col gap-1">
                <label class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">
                    Etapa
                </label>
                <select
                    id="filtro-etapa"
                    class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 text-xs text-slate-100
                           focus:outline-none focus:ring-1 focus:ring-indigo-500"
                >
                    <option value="">Todas</option>
                    <!-- Opcional: podemos carregar as etapas via API em uma próxima melhoria -->
                </select>
            </div>

            <!-- Botão aplicar -->
            <div class="flex flex-col gap-1">
                <span class="invisible text-[11px] md:visible">.</span>
                <button
                    id="btn-aplicar-filtros"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-xs font-medium
                           bg-indigo-600 hover:bg-indigo-500 text-white transition"
                >
                    Aplicar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
        <div class="border-b border-slate-800 px-4 py-2 flex items-center justify-between">
            <p class="text-xs text-slate-400">
                Lista de ordens de serviço filtradas pela sua oficina.
            </p>
            <p id="os-count" class="text-[11px] text-slate-500">
                —
            </p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
                <thead class="bg-slate-900/90 border-b border-slate-800 text-slate-400 uppercase tracking-wide">
                    <tr>
                        <th class="px-3 py-2 text-left">Código</th>
                        <th class="px-3 py-2 text-left">Placa</th>
                        <th class="px-3 py-2 text-left">Modelo</th>
                        <th class="px-3 py-2 text-left">Cliente</th>
                        <th class="px-3 py-2 text-left">Telefone</th>
                        <th class="px-3 py-2 text-left">Etapa</th>
                        <th class="px-3 py-2 text-left">Entrada</th>
                        <th class="px-3 py-2 text-left">Status</th>
                        <th class="px-3 py-2 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody id="os-tbody" class="divide-y divide-slate-800/80">
                    <!-- Linhas serão preenchidas via JS -->
                </tbody>
            </table>
        </div>

        <!-- Rodapé da tabela -->
        <div class="px-4 py-2 flex items-center justify-between border-t border-slate-800">
            <div id="os-empty" class="hidden text-[11px] text-slate-500">
                Nenhuma OS encontrada com os filtros atuais.
            </div>

            <div class="flex items-center gap-2 text-[11px] text-slate-400">
                <button
                    id="btn-prev-page"
                    class="px-2 py-1 rounded-lg border border-slate-700 disabled:opacity-40 disabled:cursor-not-allowed
                           hover:bg-slate-800/80"
                    disabled
                >
                    ◀
                </button>
                <span id="os-page-info">Página 1</span>
                <button
                    id="btn-next-page"
                    class="px-2 py-1 rounded-lg border border-slate-700 disabled:opacity-40 disabled:cursor-not-allowed
                           hover:bg-slate-800/80"
                    disabled
                >
                    ▶
                </button>
            </div>
        </div>
    </div>

    <!-- Script específico da lista de OS -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const TOKEN_KEY = "checkauto_token";

            const token = window.localStorage.getItem(TOKEN_KEY);
            const tbody = document.getElementById("os-tbody");
            const emptyMsg = document.getElementById("os-empty");
            const countLabel = document.getElementById("os-count");
            const pageInfo = document.getElementById("os-page-info");
            const btnPrev = document.getElementById("btn-prev-page");
            const btnNext = document.getElementById("btn-next-page");

            const inputSearch = document.getElementById("filtro-search");
            const selectStatus = document.getElementById("filtro-status");
            const selectEtapa = document.getElementById("filtro-etapa");
            const btnAplicar = document.getElementById("btn-aplicar-filtros");

            if (!token) {
                countLabel.textContent = "⚠ Sem token. Faça login para listar as OS.";
                return;
            }

            let currentPageUrl = "/api/os/";  // DRF com PageNumberPagination costuma usar ?page=1
            let lastResponse = null;

            function montarUrlComFiltros(baseUrl) {
                const url = new URL(baseUrl, window.location.origin);

                const search = inputSearch.value.trim();
                const status = selectStatus.value;
                const etapa = selectEtapa.value;

                if (search) {
                    url.searchParams.set("search", search);
                }
                if (status) {
                    url.searchParams.set("status", status);
                }
                if (etapa) {
                    url.searchParams.set("etapa", etapa);
                }

                return url.pathname + url.search;
            }

            function formatarDataIso(dataStr) {
                if (!dataStr) return "-";
                // Tenta cortar só a parte da data (YYYY-MM-DD)
                const apenasData = dataStr.split("T")[0];
                const partes = apenasData.split("-");
                if (partes.length === 3) {
                    return partes[2] + "/" + partes[1] + "/" + partes[0];
                }
                return apenasData;
            }

            function renderizarTabela(dados) {
                tbody.innerHTML = "";

                let lista = dados;

                // Se vier no formato paginado (DRF PageNumberPagination)
                if (dados && Array.isArray(dados.results)) {
                    lista = dados.results;
                }

                if (!lista || lista.length === 0) {
                    emptyMsg.classList.remove("hidden");
                } else {
                    emptyMsg.classList.add("hidden");
                }

                lista.forEach(os => {
                    const tr = document.createElement("tr");
                    tr.className = "hover:bg-slate-900";

                    const statusTexto = os.aberta ? "Aberta" : "Fechada";
                    const statusClasse = os.aberta
                        ? "bg-emerald-600/20 text-emerald-300 border-emerald-500/40"
                        : "bg-slate-700/40 text-slate-200 border-slate-600/50";

                    // Montar URL de detalhes (vamos implementar a view depois)
                    const detalheUrl = `/painel/os/${os.id}/`;

                    tr.innerHTML = `
                        <td class="px-3 py-2 align-middle whitespace-nowrap">${os.codigo ?? "-"}</td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap font-mono">${os.placa ?? "-"}</td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">${os.modelo_veiculo ?? "-"}</td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">${os.nome_cliente ?? "-"}</td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">${os.telefone_cliente ?? "-"}</td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">
                            ${os.etapa_nome ?? "-"}
                        </td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">
                            ${formatarDataIso(os.data_entrada)}
                        </td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] border ${statusClasse}">
                                ${statusTexto}
                            </span>
                        </td>
                        <td class="px-3 py-2 align-middle whitespace-nowrap text-right">
                            <a href="${detalheUrl}"
                               class="inline-flex items-center px-3 py-1 rounded-lg border border-slate-700
                                      text-[11px] text-slate-100 hover:bg-slate-800/80">
                                Ver detalhes
                            </a>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            }

            function atualizarPaginacao(dados) {
                // Se vier no formato paginado do DRF
                if (dados && typeof dados.count === "number") {
                    countLabel.textContent = `${dados.count} OS encontradas`;
                } else if (Array.isArray(dados)) {
                    countLabel.textContent = `${dados.length} OS encontradas`;
                } else {
                    countLabel.textContent = "—";
                }

                if (dados && Object.prototype.hasOwnProperty.call(dados, "next")) {
                    btnNext.disabled = !dados.next;
                    btnPrev.disabled = !dados.previous;

                    // Guardar as URLs de next/previous
                    btnNext.dataset.url = dados.next || "";
                    btnPrev.dataset.url = dados.previous || "";
                } else {
                    // Sem paginação (lista simples)
                    btnNext.disabled = true;
                    btnPrev.disabled = true;
                    btnNext.dataset.url = "";
                    btnPrev.dataset.url = "";
                }

                // Info básica de página (se estiver paginado)
                if (dados && typeof dados.count === "number" && dados.results) {
                    // Tentativa simples: extrair ?page=N da URL atual
                    const matchPage = currentPageUrl.match(/[\?&]page=(\d+)/);
                    const paginaAtual = matchPage ? parseInt(matchPage[1]) : 1;
                    pageInfo.textContent = `Página ${paginaAtual}`;
                } else {
                    pageInfo.textContent = "Página única";
                }
            }

            function carregarOS(url) {
                currentPageUrl = url || currentPageUrl;

                const urlComFiltros = montarUrlComFiltros(currentPageUrl);

                fetch(urlComFiltros, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`,
                    },
                })
                    .then(async (response) => {
                        if (!response.ok) {
                            const text = await response.text();
                            console.error("Erro ao listar OS:", response.status, text);
                            countLabel.textContent = "Erro ao carregar as OS. Veja o console.";
                            tbody.innerHTML = "";
                            emptyMsg.classList.remove("hidden");
                            return null;
                        }
                        return response.json();
                    })
                    .then((data) => {
                        if (!data) return;
                        lastResponse = data;
                        renderizarTabela(data);
                        atualizarPaginacao(data);
                    })
                    .catch((err) => {
                        console.error("Erro inesperado ao listar OS:", err);
                        countLabel.textContent = "Erro inesperado ao carregar as OS.";
                        tbody.innerHTML = "";
                        emptyMsg.classList.remove("hidden");
                    });
            }

            // Botão aplicar filtros
            btnAplicar.addEventListener("click", () => {
                // Sempre volta para a primeira página da API ao mudar filtros
                currentPageUrl = "/api/os/";
                carregarOS(currentPageUrl);
            });

            // Navegação entre páginas (se DRF estiver paginando)
            btnNext.addEventListener("click", () => {
                const nextUrl = btnNext.dataset.url;
                if (nextUrl) {
                    // nextUrl pode ser absoluto ou relativo
                    const path = new URL(nextUrl, window.location.origin).pathname + new URL(nextUrl, window.location.origin).search;
                    carregarOS(path);
                }
            });

            btnPrev.addEventListener("click", () => {
                const prevUrl = btnPrev.dataset.url;
                if (prevUrl) {
                    const path = new URL(prevUrl, window.location.origin).pathname + new URL(prevUrl, window.location.origin).search;
                    carregarOS(path);
                }
            });

            // Carrega a primeira vez
            carregarOS(currentPageUrl);
        });
    </script>

{% endblock %}
